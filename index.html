<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silly Me</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ['Ubuntu', 'sans-serif'],
              },
            }
          }
        }
    </script>
    <style>
        .btn-gradient {
            background-image: linear-gradient(to right, #30a84a, #29ff5a);
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(48, 168, 74, 0.4), 0 0 15px rgba(41, 255, 90, 0.3);
        }
        .btn-gradient:hover {
            box-shadow: 0 0 25px rgba(48, 168, 74, 0.7), 0 0 25px rgba(41, 255, 90, 0.5);
            transform: scale(1.03);
        }

        .style-button {
            background-color: #374151; /* bg-gray-700 */
            transition: all 0.3s ease;
        }
        .style-button:hover {
            background-color: #4B5563; /* bg-gray-600 */
            box-shadow: 0 0 5px rgba(48, 168, 74, 0.2);
            transform: scale(1.03);
        }
        .style-button.active {
            background-image: linear-gradient(to right, #30a84a, #29ff5a);
            box-shadow: 0 0 15px rgba(48, 168, 74, 0.5);
            color: white;
        }
         #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
    </style>
 </head>
<body class="text-gray-200 font-sans flex flex-col items-center p-6 min-h-screen" style="background-color: #1f2128;">
    <canvas id="particle-canvas"></canvas>

    <div class="max-w-4xl w-full flex flex-col items-center">
        <div class="text-center mb-8">
            <img src="GeminNice.png" alt="Silly Me Logo" class="mx-auto h-16 md:h-20">
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-col md:flex-row gap-8 w-full">
            
            <!-- Photo Upload & Canvas Section -->
            <div class="flex flex-col items-center flex-1">
                <div class="w-full rounded-xl shadow-lg p-6 mb-6 relative" style="background-color: #222630;">
                    <label for="fileInput" id="fileInputLabel" class="w-full cursor-pointer btn-gradient text-white py-3 px-6 rounded-xl text-center text-lg font-bold block mb-4">
                        Upload Photo
                    </label>
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                    
                    <div class="relative w-full">
                        <img id="imageDisplay" class="w-full h-auto rounded-xl shadow-md border border-gray-700 hidden" alt="Generated image">
                        <div id="loadingOverlay" class="hidden absolute inset-0 bg-gray-800 bg-opacity-80 flex items-center justify-center rounded-xl">
                            <svg class="animate-spin -ml-1 mr-3 h-12 w-12 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-gray-300 text-lg">Generating...</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                 <div class="flex flex-col items-center gap-2 w-full">
                    <p id="saveTip" class="text-lg text-gray-400 italic hidden">Press and hold to save the photo</p>
                </div>
            </div>

            <!-- Style Buttons Section -->
            <div class="flex-1 w-full md:w-auto">
                <div class="rounded-xl shadow-lg p-6" style="background-color: #222630;">
                    <h2 class="text-2xl font-bold mb-4 text-white">Choose a Style</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button id="randomButton" class="btn-gradient text-white p-4 rounded-xl font-bold shadow-lg col-span-2 sm:col-span-2 md:col-span-2 lg:col-span-3">Surprise me!</button>
                        <button class="style-button text-gray-200 p-4 rounded-xl font-bold shadow-sm" data-style="crappy-sketch">Crappy Sketch</button>
                        <button class="style-button text-gray-200 p-4 rounded-xl font-bold shadow-sm" data-style="chalk-doodle">Chalk Doodle</button>
                        <button class="style-button text-gray-200 p-4 rounded-xl font-bold shadow-sm" data-style="toddler-painting">Toddler Painting</button>
                        <button class="style-button text-gray-200 p-4 rounded-xl font-bold shadow-sm" data-style="bubblegum-sculpture">Lego Set</button>
                        <button class="style-button text-gray-200 p-4 rounded-xl font-bold shadow-sm" data-style="macaroni-portrait">Macaroni</button>
                        <button class="style-button text-gray-200 p-4 rounded-xl font-bold shadow-sm" data-style="stained-glass">Marble Statue</button>
                        <button class="style-button text-gray-200 p-4 rounded-xl font-bold shadow-sm" data-style="paint-collage">Hairdresser</button>
                        <button class="style-button text-gray-200 p-4 rounded-xl font-bold shadow-sm" data-style="figurine">Figurine</button>
                        <button class="style-button text-gray-200 p-4 rounded-xl font-bold shadow-sm" data-style="ransom-note">Comic Story</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- History Section -->
        <div class="mt-8 w-full max-w-4xl">
            <div class="rounded-xl shadow-lg p-6" style="background-color: #222630;">
                <h2 class="text-2xl font-bold mb-4 text-white">Your Creations</h2>
                <div id="historyContainer" class="flex flex-wrap gap-4 overflow-x-auto p-2">
                    <!-- History items will be rendered here -->
                </div>
            </div>
        </div>

    </div>
    
    <!-- Message Box Modal -->
    <div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="rounded-xl p-8 shadow-2xl max-w-sm w-full border border-gray-700" style="background-color: #222630;">
            <p id="modalText" class="text-center text-lg font-medium text-gray-200 mb-6"></p>
            <button id="closeModalButton" class="w-full btn-gradient text-white font-bold py-3 rounded-xl">Got it</button>
        </div>
    </div>
    
    <!-- Image Display Modal -->
    <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="relative rounded-xl p-4 shadow-2xl max-w-lg max-h-[90%] w-full flex flex-col border border-gray-700" style="background-color: #222630;">
            <button id="closeImageModalButton" class="absolute top-2 right-2 text-white bg-red-500 p-2 rounded-full font-bold text-lg leading-none w-8 h-8 flex items-center justify-center z-10">Ã—</button>
            <img id="enlargedImage" src="" alt="Enlarged styled image" class="w-full h-auto object-contain rounded-xl">
        </div>
    </div>

    <script type="module">
        // Global variables
        let creationHistory = [];

        const prompts = {
            'crappy-sketch': 'a scan of a sketch made using a biro on lined paper, it is of a really bad drawn by someone who has never seen this person, bit strange, it\\\'s not very good, can\\\'t draw, doodle like, in blue ink on white A4 paper',
            'chalk-doodle': 'A smudged portrait of a person crudely drawn with a stick of white chalk on a dusty, black chalkboard. The lines are not sharp, and some parts are partially erased or smudged, leaving behind a hazy, ghost-like residue. There are visible traces of chalk dust on the bottom.',
            'toddler-painting': 'A simple and slightly lopsided portrait of a person\\\'s face, created with thick, uneven blobs of primary-colored paint. The colors are mixed messily in places, and the overall impression is one of a hurried, happy, and chaotic art project on a sheet of butcher paper.',
            'bubblegum-sculpture': 'Transform the person in the photo into a LEGO minifigure packaging box style, presented in isometric perspective. Label the box with the title "It\'s me!". Inside the box, display the LEGO minifigure based on the person in the photo, along with their essential items (or items that are seen in the photo) as LEGO accessories. Beside the box, also display the actual LEGO minifigure itself, unpackaged, rendered in a realistic and vivid style.',
            'macaroni-portrait': 'A portrait of a person constructed entirely from various shapes of dried macaroni and cheese noodles. The noodles are glued on unevenly, some are broken, and the overall form is a very poor representation of the person, glued on a brown piece of construction paper.',
            'stained-glass': 'A photorealistic image of an ultra-detailed sculpture of the subject in image made of marble. The sculpture should display smooth and reflective marble surface, emphasizing its luster and artistic craftsmanship. The design is elegant, highlighting the beauty and depth of marble. The lighting in the image should enhance the sculpture\'s contours and textures, creating a visually stunning and mesmerizing effect.',
            'paint-collage': 'Generate avatars of this person with different hairstyles in a 3x3 grid format.',
            'figurine': 'Create a 1/7 scale commercialized figurine of the characters in the picture, in a realistic style, in a real environment. The figurine is placed on a computer desk. The figurine has a round transparent acrylic base, with no text on the base. The content on the computer screen is a 3D modeling process of this figurine. Next to the computer screen is a toy packaging box, designed in a style reminiscent of high-quality collectible figures, printed with original artwork. The packaging features two-dimensional flat illustrations.',
            'ransom-note': 'make a comic book strip, add text, write a compelling story. I want a superhero comic book',
        };
        
        const imageDisplay = document.getElementById('imageDisplay');
        const fileInput = document.getElementById('fileInput');
        const fileInputLabel = document.getElementById('fileInputLabel');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const randomButton = document.getElementById('randomButton');
        const historyContainer = document.getElementById('historyContainer');
        const imageModal = document.getElementById('imageModal');
        const enlargedImage = document.getElementById('enlargedImage');
        const closeModalButton = document.getElementById('closeModalButton');
        const messageModal = document.getElementById('messageModal');
        const modalText = document.getElementById('modalText');
        const closeImageModalButton = document.getElementById('closeImageModalButton');
        const styleButtons = document.querySelectorAll('.style-button');
        const saveTip = document.getElementById('saveTip');
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        let originalImage = null;
        let originalImageMimeType = null;
        let currentImage = null;
        
        // --- Particle Effect ---
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function createParticles(x, y) {
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    size: Math.random() * 2 + 1,
                    alpha: 1
                });
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                p.vx *= 0.99;
                p.vy += 0.05; // Gravity
                p.x += p.vx;
                p.y += p.vy;
                p.alpha -= 0.02;

                if (p.alpha <= 0) {
                    particles.splice(i, 1);
                } else {
                    ctx.fillStyle = `rgba(255, 255, 255, 1)`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            if (particles.length > 0) {
                requestAnimationFrame(animateParticles);
            }
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();


        // --- Event Listeners ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                originalImageMimeType = file.type;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        imageDisplay.src = event.target.result;
                        originalImage = event.target.result;
                        currentImage = originalImage;
                        fileInputLabel.textContent = 'Change Photo';
                        imageDisplay.classList.remove('hidden');
                        saveTip.classList.add('hidden'); // Hide tip on new upload
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        styleButtons.forEach(button => {
            button.addEventListener('click', async () => {
                styleButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                const styleName = button.dataset.style;
                const prompt = prompts[styleName];
                if (prompt) {
                    await generateImage(prompt);
                }
            });
        });

        randomButton.addEventListener('click', async (e) => {
            styleButtons.forEach(btn => btn.classList.remove('active'));
            const rect = e.target.getBoundingClientRect();
            createParticles(rect.left + rect.width / 2, rect.top + rect.height / 2);
            animateParticles();
            await generateRandomPromptAndImage();
        });

        closeImageModalButton.addEventListener('click', () => {
            imageModal.classList.add('hidden');
        });

        closeModalButton.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });
        
        imageDisplay.addEventListener('click', () => {
            if (currentImage) {
                enlargedImage.src = currentImage;
                imageModal.classList.remove('hidden');
            }
        });

        async function generateImage(prompt) {
            if (!originalImage) {
                return showMessage("Please upload an image first.");
            }

            loadingOverlay.classList.remove('hidden');
            imageDisplay.src = originalImage;
            saveTip.classList.add('hidden');

            try {
                const imageData = originalImage.split(',')[1];
                
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, imageData, mimeType: originalImageMimeType }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || "Failed to generate image.");
                }

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

                if (!base64Data) {
                    throw new Error("No image data received from API.");
                }

                const newImageUrl = `data:image/jpeg;base64,${base64Data}`;
                
                imageDisplay.src = newImageUrl;
                currentImage = newImageUrl;
                    
                creationHistory.push({
                    id: Date.now(),
                    image: currentImage,
                    prompt: prompt
                });
                renderHistory();
                saveTip.classList.remove('hidden');
                
            } catch (error) {
                console.error("Image generation failed:", error);
                showMessage(`Image generation failed: ${error.message}`);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function generateRandomPromptAndImage() {
            if (!originalImage) {
                return showMessage("Please upload an image first.");
            }

            loadingOverlay.classList.remove('hidden');
            saveTip.classList.add('hidden');

            if (window.innerWidth < 768) {
                document.getElementById('imageDisplay').scrollIntoView({ behavior: 'smooth' });
            }
            imageDisplay.src = originalImage;

            try {
                const response = await fetch('/api/generate-prompt');
                if (!response.ok) {
                     const errorBody = await response.json();
                    throw new Error(errorBody.error || "Failed to get a random prompt from the server.");
                }

                const result = await response.json();
                const randomPrompt = result.prompt;
                
                await generateImage(randomPrompt);
                
            } catch (error) {
                console.error("Random prompt generation failed:", error);
                showMessage(`Failed to generate a new prompt: ${error.message}`);
                loadingOverlay.classList.add('hidden');
            }
        }

        function renderHistory() {
            historyContainer.innerHTML = '';
            creationHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.classList.add('w-24', 'h-24', 'overflow-hidden', 'rounded-lg', 'shadow-md', 'cursor-pointer', 'transition-transform', 'hover:scale-105');
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.prompt;
                img.classList.add('w-full', 'h-full', 'object-cover');
                
                historyItem.addEventListener('click', () => {
                    enlargedImage.src = item.image;
                    imageModal.classList.remove('hidden');
                });

                historyItem.appendChild(img);
                historyContainer.appendChild(historyItem);
            });
        }
        
        function showMessage(message) {
            modalText.textContent = message;
            messageModal.classList.remove('hidden');
        }
        
    </script>
</body>
</html>

