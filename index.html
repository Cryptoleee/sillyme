<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silly Me</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
 </head>
<body class="bg-gray-50 text-gray-900 font-[Inter] flex flex-col items-center p-6 min-h-screen">

    <div class="max-w-4xl w-full flex flex-col items-center">
        <h1 class="text-5xl font-bold text-center text-gray-800 mb-2">Silly me!</h1>
        <p class="text-xl text-center text-gray-600 mb-6">Create something cool.</p>

        <!-- Main Content Area -->
        <div class="flex flex-col md:flex-row gap-8 w-full">
            
            <!-- Photo Upload & Canvas Section -->
            <div class="flex flex-col items-center flex-1">
                <div class="w-full bg-white rounded-xl shadow-lg p-6 mb-6 relative">
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                    <label for="fileInput" id="fileInputLabel" class="w-full cursor-pointer bg-blue-500 text-white py-3 px-6 rounded-xl text-center text-lg font-bold hover:bg-blue-600 transition-colors duration-200 block mb-4">
                        Upload Photo
                    </label>
                    
                    <div class="relative w-full">
                        <img id="imageDisplay" class="w-full h-auto rounded-xl shadow-md border border-gray-200 hidden" alt="Generated image">
                        <div id="loadingOverlay" class="hidden absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center rounded-xl">
                            <svg class="animate-spin -ml-1 mr-3 h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-gray-700 text-lg">Generating...</span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap justify-center gap-4 w-full">
                    <button id="downloadButton" class="bg-green-500 text-white font-bold py-3 px-6 rounded-xl transition-transform hover:scale-105 shadow-lg w-full md:w-auto">Download</button>
                </div>
            </div>

            <!-- Style Buttons Section -->
            <div class="flex-1 w-full md:w-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Choose a Style</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button class="style-button bg-gray-100 text-gray-800 p-4 rounded-xl font-bold shadow-sm transition-transform hover:scale-105" data-style="crappy-sketch">Crappy Sketch</button>
                        <button class="style-button bg-gray-100 text-gray-800 p-4 rounded-xl font-bold shadow-sm transition-transform hover:scale-105" data-style="chalk-doodle">Chalk Doodle</button>
                        <button class="style-button bg-gray-100 text-gray-800 p-4 rounded-xl font-bold shadow-sm transition-transform hover:scale-105" data-style="toddler-painting">Toddler Painting</button>
                        <button class="style-button bg-gray-100 text-gray-800 p-4 rounded-xl font-bold shadow-sm transition-transform hover:scale-105" data-style="bubblegum-sculpture">Bubblegum Sculpture</button>
                        <button class="style-button bg-gray-100 text-gray-800 p-4 rounded-xl font-bold shadow-sm transition-transform hover:scale-105" data-style="macaroni-portrait">Macaroni Portrait</button>
                        <button class="style-button bg-gray-100 text-gray-800 p-4 rounded-xl font-bold shadow-sm transition-transform hover:scale-105" data-style="stained-glass">Stained Glass Mosaic</button>
                        <button class="style-button bg-gray-100 text-gray-800 p-4 rounded-xl font-bold shadow-sm transition-transform hover:scale-105" data-style="paint-collage">Textured Paint Collage</button>
                        <button class="style-button bg-gray-100 text-gray-800 p-4 rounded-xl font-bold shadow-sm transition-transform hover:scale-105" data-style="figurine">Figurine</button>
                        <button class="style-button bg-gray-100 text-gray-800 p-4 rounded-xl font-bold shadow-sm transition-transform hover:scale-105" data-style="ransom-note">Ransom Note</button>
                        <button id="randomButton" class="bg-blue-500 text-white p-4 rounded-xl font-bold shadow-lg transition-transform hover:scale-105 col-span-2 sm:col-span-2 md:col-span-2 lg:col-span-3">Random Style</button>
                        <div id="randomPromptDisplay" class="col-span-2 sm:col-span-2 md:col-span-2 lg:col-span-3 text-sm text-center text-gray-600 mt-2 p-2 rounded-xl bg-gray-100 hidden"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- History Section -->
        <div class="mt-8 w-full max-w-4xl">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Your Creations</h2>
                <div id="historyContainer" class="flex flex-wrap gap-4 overflow-x-auto p-2">
                    <!-- History items will be rendered here -->
                </div>
            </div>
        </div>

    </div>
    
    <!-- Message Box Modal -->
    <div id="messageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl p-8 shadow-2xl max-w-sm w-full">
            <p id="modalText" class="text-center text-lg font-medium text-gray-800 mb-6"></p>
            <button id="closeModalButton" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl transition-colors hover:bg-blue-600">Got it</button>
        </div>
    </div>
    
    <!-- Image Display Modal -->
    <div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="relative bg-white rounded-xl p-4 shadow-2xl max-w-lg max-h-[90%] w-full flex flex-col">
            <button id="closeImageModalButton" class="absolute top-2 right-2 text-white bg-red-500 p-2 rounded-full font-bold font-bold text-lg leading-none w-8 h-8 flex items-center justify-center">Ã—</button>
            <img id="enlargedImage" src="" alt="Enlarged styled image" class="w-full h-auto object-contain rounded-xl">
        </div>
    </div>

    <script type="module">
        // Global variables
        let currentPrompt = '';
        let creationHistory = [];

        const prompts = {
            'crappy-sketch': 'a scan of a sketch made using a biro on lined paper, it is of a really bad drawn by someone who has never seen this person, bit strange, it\'s not very good, can\'t draw, doodle like, in blue ink on white A4 paper',
            'chalk-doodle': 'A smudged portrait of a person crudely drawn with a stick of white chalk on a dusty, black chalkboard. The lines are not sharp, and some parts are partially erased or smudged, leaving behind a hazy, ghost-like residue. There are visible traces of chalk dust on the bottom.',
            'toddler-painting': 'A simple and slightly lopsided portrait of a person\'s face, created with thick, uneven blobs of primary-colored paint. The colors are mixed messily in places, and the overall impression is one of a hurried, happy, and chaotic art project on a sheet of butcher paper.',
            'bubblegum-sculpture': 'An abstract, lumpy, and slightly glistening portrait bust of a person. It is sculpted from bright pink chewed bubblegum, with some stretched, stringy pieces and a few stray crumbs stuck to it. The entire thing is stuck to a piece of faded cardboard.',
            'macaroni-portrait': 'A portrait of a person constructed entirely from various shapes of dried macaroni and cheese noodles. The noodles are glued on unevenly, some are broken, and the overall form is a very poor representation of the person, glued on a brown piece of construction paper.',
            'stained-glass': 'A detailed portrait of a person as a mosaic of multicolored, translucent stained glass pieces joined by black leading lines. The image should be vibrant and have a shattered, yet beautiful effect.',
            'paint-collage': 'A portrait of a person created as a collage of thick, textural paint strokes, torn magazine paper, and ink splatters. The style should be energetic, chaotic, and abstract, with a mix of different media.',
            'figurine': 'Create a 1/7 scale commercialized figurine of the characters in the picture, in a realistic style, in a real environment. The figurine is placed on a computer desk. The figurine has a round transparent acrylic base, with no text on the base. The content on the computer screen is a 3D modeling process of this figurine. Next to the computer screen is a toy packaging box, designed in a style reminiscent of high-quality collectible figures, printed with original artwork. The packaging features two-dimensional flat illustrations.',
            'ransom-note': 'A portrait of a person where their face and features are made up of cut-out pictures from different magazines. Their eyes, nose, and mouth are all from different people, glued haphazardly onto a piece of cardboard with visible glue residue on the edges.',
        };

        const imageDisplay = document.getElementById('imageDisplay');
        const fileInput = document.getElementById('fileInput');
        const fileInputLabel = document.getElementById('fileInputLabel');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const downloadButton = document.getElementById('downloadButton');
        const randomButton = document.getElementById('randomButton');
        const historyContainer = document.getElementById('historyContainer');
        const imageModal = document.getElementById('imageModal');
        const enlargedImage = document.getElementById('enlargedImage');
        const closeModalButton = document.getElementById('closeModalButton');
        const messageModal = document.getElementById('messageModal');
        const modalText = document.getElementById('modalText');
        const closeImageModalButton = document.getElementById('closeImageModalButton');
        const randomPromptDisplay = document.getElementById('randomPromptDisplay');

        let originalImage = null;
        let currentImage = null;

        // --- Event Listeners ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        imageDisplay.src = event.target.result;
                        originalImage = event.target.result;
                        currentImage = originalImage;
                        fileInputLabel.textContent = 'Change Photo';
                        imageDisplay.classList.remove('hidden');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        document.querySelectorAll('.style-button').forEach(button => {
            button.addEventListener('click', async () => {
                const styleName = button.dataset.style;
                const prompt = prompts[styleName];
                if (prompt) {
                    randomPromptDisplay.classList.add('hidden');
                    randomPromptDisplay.textContent = '';
                    await generateImage(prompt);
                }
            });
        });

        randomButton.addEventListener('click', async () => {
            await generateRandomPromptAndImage();
        });

        downloadButton.addEventListener('click', () => {
            if (!currentImage) {
                showMessage("Please generate an image first.");
                return;
            }
            const link = document.createElement('a');
            link.href = currentImage;
            link.download = 'silly-me-creation.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        closeImageModalButton.addEventListener('click', () => {
            imageModal.classList.add('hidden');
        });

        closeModalButton.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });
        
        imageDisplay.addEventListener('click', () => {
            if (currentImage) {
                enlargedImage.src = currentImage;
                imageModal.classList.remove('hidden');
            }
        });


        // --- Functions ---
        async function generateImage(prompt) {
            if (!originalImage) {
                showMessage("Please upload an image first.");
                return;
            }

            loadingOverlay.classList.remove('hidden');
            imageDisplay.src = originalImage;

            try {
                const imageData = originalImage.split(',')[1];
                
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, imageData }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || "Failed to generate image.");
                }

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

                if (!base64Data) {
                    throw new Error("No image data received from API.");
                }

                const newImageUrl = `data:image/jpeg;base64,${base64Data}`;
                
                imageDisplay.src = newImageUrl;
                currentImage = newImageUrl;
                    
                creationHistory.push({
                    id: Date.now(),
                    image: currentImage,
                    prompt: prompt
                });
                renderHistory();
                downloadButton.classList.remove('hidden');
                
            } catch (error) {
                console.error("Image generation failed:", error);
                showMessage("Failed to generate image after multiple retries. Please try again later.");
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function generateRandomPromptAndImage() {
            if (!originalImage) {
                showMessage("Please upload an image first.");
                return;
            }

            loadingOverlay.classList.remove('hidden');
            // Scroll to the canvas on mobile so the user can see the generation
            if (window.innerWidth < 768) {
                document.getElementById('imageDisplay').scrollIntoView({ behavior: 'smooth' });
            }
            imageDisplay.src = originalImage;

            try {
                const response = await fetch('/api/generate-prompt');
                if (!response.ok) {
                    throw new Error("Failed to get a random prompt from the server.");
                }
                const result = await response.json();
                const randomPrompt = result.prompt;
                
                randomPromptDisplay.textContent = randomPrompt;
                randomPromptDisplay.classList.remove('hidden');

                await generateImage(randomPrompt);
                
            } catch (error) {
                console.error("Random prompt generation failed:", error);
                showMessage("Failed to generate a new prompt. Please try again later.");
                loadingOverlay.classList.add('hidden');
            }
        }

        function renderHistory() {
            historyContainer.innerHTML = '';
            creationHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.classList.add('w-24', 'h-24', 'overflow-hidden', 'rounded-lg', 'shadow-md', 'cursor-pointer', 'transition-transform', 'hover:scale-105');
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.prompt;
                img.classList.add('w-full', 'h-full', 'object-cover');
                
                historyItem.addEventListener('click', () => {
                    enlargedImage.src = item.image;
                    imageModal.classList.remove('hidden');
                });

                historyItem.appendChild(img);
                historyContainer.appendChild(historyItem);
            });
        }
        
        function showMessage(message) {
            modalText.textContent = message;
            messageModal.classList.remove('hidden');
        }
        
    </script>
</body>
</html>
